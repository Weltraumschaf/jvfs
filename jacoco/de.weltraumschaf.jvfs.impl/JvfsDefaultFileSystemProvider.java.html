<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JvfsDefaultFileSystemProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JVFS</a> &gt; <a href="index.html" class="el_package">de.weltraumschaf.jvfs.impl</a> &gt; <span class="el_source">JvfsDefaultFileSystemProvider.java</span></div><h1>JvfsDefaultFileSystemProvider.java</h1><pre class="source lang-java linenums">/*
 *  LICENSE
 *
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 43):
 * &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt; wrote this file.
 * As long as you retain this notice you can do whatever you want with
 * this stuff. If we meet some day, and you think this stuff is worth it,
 * you can buy me a non alcohol-free beer in return.
 *
 * Copyright (C) 2012 &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt;
 */

package de.weltraumschaf.jvfs.impl;

import de.weltraumschaf.jvfs.JvfsAssertions;
import de.weltraumschaf.jvfs.JvfsFileSystems;
import java.io.IOException;
import java.net.URI;
import java.nio.channels.SeekableByteChannel;
import java.nio.file.AccessMode;
import java.nio.file.CopyOption;
import java.nio.file.DirectoryStream;
import java.nio.file.FileStore;
import java.nio.file.FileSystem;
import java.nio.file.LinkOption;
import java.nio.file.OpenOption;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.BasicFileAttributes;
import java.nio.file.attribute.FileAttribute;
import java.nio.file.attribute.FileAttributeView;
import java.nio.file.spi.FileSystemProvider;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;

/**
 * A provider implementation which is registered as default file system.
 *
 * Via {@link JvfsFileSystems} you can mount virtual in memory file systems.
 * This provider will dispatches all paths matching a mounted file system
 * to {@link JvfsFileSystemProvider}.
 *
 * @author Sven Strittmatter &lt;weltraumschaf@googlemail.com&gt;
 */
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">public class JvfsDefaultFileSystemProvider extends FileSystemProvider {</span>

    /**
     * The default system provider.
     */
    private final FileSystemProvider parent;
    /**
     * Virtual file system.
     */
    private final FileSystemProvider jvfs;
    /**
     * Holds the mount points.
     */
    private final Map&lt;String, FileSystem&gt; fstab;

    /**
     * Constructor used by {@link java.nio.file.FileSystems} to create default provider.
     *
     * @param parent is ignored at the moment, necessary that JVM default factory can instantiate
     */
    public JvfsDefaultFileSystemProvider(final FileSystemProvider parent) {
<span class="nc" id="L67">        this(parent, JvfsFileSystems.getInstance().getFstab(), new JvfsFileSystemProvider(false));</span>
<span class="nc" id="L68">    }</span>

    /**
     * Dedicated constructor.
     *
     * @param parent must not be {@literal null}
     * @param fstab must not be {@literal null}
     * @param jvfs must not be {@literal null}
     */
    JvfsDefaultFileSystemProvider(
        final FileSystemProvider parent, final Map&lt;String, FileSystem&gt; fstab, final FileSystemProvider jvfs) {
<span class="fc" id="L79">        super();</span>
<span class="fc" id="L80">        JvfsAssertions.notNull(parent, &quot;parent&quot;);</span>
<span class="fc" id="L81">        this.parent = parent;</span>
<span class="fc" id="L82">        JvfsAssertions.notNull(fstab, &quot;fstab&quot;);</span>
<span class="fc" id="L83">        this.fstab = fstab;</span>
<span class="fc" id="L84">        JvfsAssertions.notNull(jvfs, &quot;jvfs&quot;);</span>
<span class="fc" id="L85">        this.jvfs = jvfs;</span>
<span class="fc" id="L86">    }</span>

    @Override
    public String getScheme() {
<span class="nc" id="L90">        return parent.getScheme();</span>
    }

    @Override
    public FileSystem newFileSystem(final URI uri, final Map&lt;String, ?&gt; env) throws IOException {
<span class="nc" id="L95">        return parent.newFileSystem(uri, env);</span>
    }

    @Override
    public FileSystem getFileSystem(final URI uri) {
<span class="nc" id="L100">        return parent.getFileSystem(uri);</span>
    }

    @Override
    public Path getPath(final URI uri) {
<span class="nc" id="L105">        return parent.getPath(uri);</span>
    }

    @Override
    public SeekableByteChannel newByteChannel(
        final Path path, final Set&lt;? extends OpenOption&gt; options, final FileAttribute&lt;?&gt;... attrs) throws IOException {

<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L113">            return jvfs.newByteChannel(translate(path), options, attrs);</span>
        }

<span class="nc" id="L116">        return parent.newByteChannel(path, options, attrs);</span>
    }

    @Override
    public DirectoryStream&lt;Path&gt; newDirectoryStream(
        final Path dir, final DirectoryStream.Filter&lt;? super Path&gt; filter) throws IOException {

<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (isMounted(dir)) {</span>
<span class="nc" id="L124">            return jvfs.newDirectoryStream(translate(dir), filter);</span>
        }

<span class="nc" id="L127">        return parent.newDirectoryStream(dir, filter);</span>
    }

    @Override
    public void createDirectory(final Path dir, final FileAttribute&lt;?&gt;... attrs) throws IOException {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (isMounted(dir)) {</span>
<span class="nc" id="L133">            jvfs.createDirectory(translate(dir), attrs);</span>
<span class="nc" id="L134">            return;</span>
        }

<span class="nc" id="L137">        parent.createDirectory(dir, attrs);</span>
<span class="nc" id="L138">    }</span>

    @Override
    public void delete(final Path path) throws IOException {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L143">            jvfs.delete(translate(path));</span>
<span class="nc" id="L144">            return;</span>
        }

<span class="nc" id="L147">        parent.delete(path);</span>
<span class="nc" id="L148">    }</span>

    @Override
    public void copy(final Path source, final Path target, final CopyOption... options) throws IOException {
<span class="nc bnc" id="L152" title="All 4 branches missed.">        if (isMounted(source) &amp;&amp; isMounted(target)) {</span>
<span class="nc" id="L153">            jvfs.copy(translate(source), translate(target), options);</span>
<span class="nc" id="L154">            return;</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">        } else if (!isMounted(source) &amp;&amp; !isMounted(target)) {</span>
<span class="nc" id="L156">            parent.copy(source, target, options);</span>
<span class="nc" id="L157">            return;</span>
        }

<span class="nc" id="L160">        throw new UnsupportedOperationException(&quot;Copy over different file systems not provided!&quot;);</span>
    }

    @Override
    public void move(final Path source, final Path target, final CopyOption... options) throws IOException {
<span class="nc bnc" id="L165" title="All 4 branches missed.">        if (isMounted(source) &amp;&amp; isMounted(target)) {</span>
<span class="nc" id="L166">            jvfs.move(translate(source), translate(target), options);</span>
<span class="nc" id="L167">            return;</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">        } else if (!isMounted(source) &amp;&amp; !isMounted(target)) {</span>
<span class="nc" id="L169">            parent.move(source, target, options);</span>
<span class="nc" id="L170">            return;</span>
        }

<span class="nc" id="L173">        throw new UnsupportedOperationException(&quot;Move over different file systems not provided!&quot;);</span>
    }

    @Override
    public boolean isSameFile(final Path path, final Path path2) throws IOException {
<span class="nc bnc" id="L178" title="All 4 branches missed.">        if (isMounted(path) &amp;&amp; isMounted(path)) {</span>
<span class="nc" id="L179">            return jvfs.isSameFile(translate(path), translate(path));</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">        } else if (!isMounted(path) &amp;&amp; !isMounted(path)) {</span>
<span class="nc" id="L181">            return parent.isSameFile(path, path);</span>
        }

<span class="nc" id="L184">        throw new UnsupportedOperationException(&quot;Is same file check over different file systems not provided!&quot;);</span>
    }

    @Override
    public boolean isHidden(final Path path) throws IOException {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L190">            return jvfs.isHidden(translate(path));</span>
        }

<span class="nc" id="L193">        return parent.isHidden(path);</span>
    }

    @Override
    public FileStore getFileStore(final Path path) throws IOException {
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L199">            return jvfs.getFileStore(translate(path));</span>
        }

<span class="nc" id="L202">        return parent.getFileStore(path);</span>
    }

    @Override
    public void checkAccess(final Path path, final AccessMode... modes) throws IOException {
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L208">            jvfs.checkAccess(translate(path), modes);</span>
        }

<span class="nc" id="L211">        parent.checkAccess(path, modes);</span>
<span class="nc" id="L212">    }</span>

    @Override
    public &lt;V extends FileAttributeView&gt; V getFileAttributeView(
        final Path path, final Class&lt;V&gt; type, final LinkOption... options) {
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L218">            return jvfs.getFileAttributeView(translate(path), type, options);</span>
        }

<span class="nc" id="L221">        return parent.getFileAttributeView(path, type, options);</span>
    }

    @Override
    public &lt;A extends BasicFileAttributes&gt; A readAttributes(
        final Path path, final Class&lt;A&gt; type, final LinkOption... options) throws IOException {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L228">            return jvfs.readAttributes(translate(path), type, options);</span>
        }

<span class="nc" id="L231">        return parent.readAttributes(path, type, options);</span>
    }

    @Override
    public Map&lt;String, Object&gt; readAttributes(
        final Path path, final String attributes, final LinkOption... options) throws IOException {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L238">            return jvfs.readAttributes(translate(path), attributes, options);</span>
        }

<span class="nc" id="L241">        return parent.readAttributes(path, attributes, options);</span>
    }

    @Override
    public void setAttribute(
        final Path path, final String attribute, final Object value, final LinkOption... options) throws IOException {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (isMounted(path)) {</span>
<span class="nc" id="L248">            jvfs.setAttribute(translate(path), attribute, value, options);</span>
        }

<span class="nc" id="L251">        parent.setAttribute(path, attribute, value, options);</span>
<span class="nc" id="L252">    }</span>

    /**
     * Checks if the given path is in a mounted directory.
     *
     * @param path must not be {@literal null}
     * @return {@literal true} if the path starts with a mount point, else {@literal false}
     */
    boolean isMounted(final Path path) {
<span class="pc bpc" id="L261" title="2 of 4 branches missed.">        assert path != null : &quot;path must be defined&quot;;</span>

<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (fstab.isEmpty()) {</span>
<span class="fc" id="L264">            return false;</span>
        }

<span class="fc" id="L267">        final String pathName = path.toString();</span>
<span class="fc" id="L268">        final Iterator&lt;Map.Entry&lt;String, FileSystem&gt;&gt;  it = fstab.entrySet().iterator();</span>

<span class="fc bfc" id="L270" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">            if (pathName.startsWith(it.next().getKey())) {</span>
<span class="fc" id="L272">                return true;</span>
            }
        }

<span class="fc" id="L276">        return false;</span>
    }

    /**
     * Translates a path to a JVFS path.
     *
     * @param path must not be {@code null}
     * @return never {@code null}
     */
    Path translate(final Path path) {
<span class="nc" id="L286">        return Paths.get(JvfsFileSystems.createUri(path.toString()));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>